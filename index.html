<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>נתוני עורכי ויקיפדיה</title>
  <style>
    body { font-family: Arial; direction: rtl; padding: 20px; background: #f4f4f4; }
    h1 { color: #2c3e50; }
    .data-section { background: white; padding: 15px; margin-top: 20px; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: right; }
    th { background-color: #eee; }
  </style>
</head>
<body>

<h1 id="page-title">נתוני עורכי ויקיפדיה - נכון ל...</h1>

<div class="data-section">
  <h2>מספר עורכים פעילים (ב־30 הימים האחרונים)</h2>
  <p id="active-editors">טוען...</p>
</div>

<div class="data-section">
  <h2>חלוקה לפי הרשאות משתמש</h2>
  <p>(טעינת כל המשתמשים עשויה לקחת מספר שניות...)</p>
  <table id="user-groups-table">
    <thead>
      <tr><th>הרשאה</th><th>מספר משתמשים</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  function updateTime() {
    const now = new Date();
    const formatted = now.toLocaleString('he-IL');
    document.getElementById('page-title').textContent = `נתוני עורכי ויקיפדיה - נכון ל־${formatted}`;
  }

  async function fetchActiveEditors() {
    const res = await fetch('https://he.wikipedia.org/w/api.php?action=query&meta=siteinfo&siprop=statistics&format=json&origin=*');
    const data = await res.json();
    const count = data?.query?.statistics?.activeusers ?? 'לא ידוע';
    document.getElementById('active-editors').textContent = count.toLocaleString();
  }

  async function fetchAllUserGroups() {
    let allUsers = [];
    let continueFrom = null;

    do {
      const url = new URL('https://he.wikipedia.org/w/api.php');
      url.search = new URLSearchParams({
        action: 'query',
        list: 'allusers',
        format: 'json',
        auprop: 'groups',
        aulimit: '500',
        origin: '*',
        ...(continueFrom && { aucontinue: continueFrom })
      });

      const res = await fetch(url);
      const data = await res.json();
      allUsers.push(...(data.query.allusers || []));
      continueFrom = data.continue?.aucontinue;
    } while (continueFrom);

    const groupCounts = {};
    for (const user of allUsers) {
      if (user.groups && user.groups.length > 0) {
        user.groups.forEach(group => {
          groupCounts[group] = (groupCounts[group] || 0) + 1;
        });
      } else {
        groupCounts['ללא הרשאה מיוחדת'] = (groupCounts['ללא הרשאה מיוחדת'] || 0) + 1;
      }
    }

    const tbody = document.querySelector('#user-groups-table tbody');
    tbody.innerHTML = '';
    Object.entries(groupCounts).sort((a, b) => b[1] - a[1]).forEach(([group, count]) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${group}</td><td>${count.toLocaleString()}</td>`;
      tbody.appendChild(row);
    });
  }

  updateTime();
  fetchActiveEditors();
  fetchAllUserGroups();
</script>

</body>
</html>
